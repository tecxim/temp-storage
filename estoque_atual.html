<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Estoque Atual</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1"></script>
  <style>
    :root {
        --primary-blue: #3498db;
        --secondary-blue: #007bff;
        --dark-gray: #6c757d;
        --light-gray: #f4f4f4;
        --white: #ffffff;
        --border-color: #ddd;
        --hover-color: #f5f5f5;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Segoe UI', Arial, sans-serif !important;
        font-size: 13px !important;
        background-color: var(--light-gray) !important;
        color: #333 !important;
        line-height: 1.4 !important;
        padding: 15px !important;
    }

    /* Cabeçalho */
    .header {
        background: var(--primary-blue) !important;
        padding: 15px 20px !important;
        color: white !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }

    .header h2 {
        font-size: 20px !important;
        font-weight: 600 !important;
        margin: 0 !important;
    }

    /* Filtros */
    .filter-container {
        display: flex !important;
        align-items: center !important;
        padding: 15px 20px !important;
        background: #f9f9f9 !important;
        border-bottom: 1px solid var(--border-color) !important;
        gap: 15px !important;
        flex-wrap: wrap !important;
    }

    .filter-group {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
    }

    .filter-group label {
        font-size: 13px !important;
        font-weight: 500 !important;
        white-space: nowrap !important;
    }

    /* Inputs personalizados (evitando .form-control do Bootstrap) */
    .custom-form-control {
        padding: 8px 10px !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 4px !important;
        font-size: 13px !important;
        min-width: 130px !important;
    }

    /* Botões personalizados (evitando .btn do Bootstrap) */
    .custom-btn {
        padding: 8px 14px !important;
        border: none !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 6px !important;
        transition: all 0.2s !important;
    }

    .custom-btn-primary {
        background-color: var(--dark-gray) !important;
        color: white !important;
    }

    .custom-btn-primary:hover {
        background-color: #5a6268 !important;
    }

    /* Tabela personalizada (evitando .table do Bootstrap) */
    .custom-table-container {
        overflow-x: auto !important;
        margin-top: 15px !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 6px !important;
    }

    .custom-table {
        width: 100% !important;
        border-collapse: collapse !important;
        min-width: 800px !important;
    }

    .custom-table th {
        background-color: var(--primary-blue) !important;
        color: white !important;
        padding: 12px 10px !important;
        text-align: left !important;
        font-weight: 600 !important;
        font-size: 13px !important;
    }

    .custom-table td {
        padding: 10px !important;
        border-bottom: 1px solid var(--border-color) !important;
        font-size: 13px !important;
    }

    .custom-table tr:last-child td {
        border-bottom: none !important;
    }

    .custom-table tr:hover {
        background-color: var(--hover-color) !important;
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .filter-container {
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 10px !important;
        }

        .filter-group {
            width: 100% !important;
            justify-content: space-between !important;
        }

        .custom-form-control {
            flex-grow: 1 !important;
            max-width: 200px !important;
        }
    }
</style>
</head>
<body>
  <div class="container">
    <!-- Cabeçalho -->
    <div class="header">
      <h2>ESTOQUE ATUAL E CMP</h2>
      <div>
        <button class="btn btn-primary" onclick="generateReport()">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filter-container">
      <div class="filter-group">
        <label for="search-term">Pesquisar:</label>
        <input
          type="text"
          id="search-term"
          class="form-control"
          placeholder="Código ou Produto"
          onkeyup="applyFilters()"
        >
      </div>
      <div class="filter-group">
        <label for="min-qtd">Qtd. Mínima:</label>
        <input
          type="number"
          id="min-qtd"
          class="form-control"
          min="0"
          onchange="applyFilters()"
        >
      </div>
      <div class="filter-group">
        <label for="max-qtd">Qtd. Máxima:</label>
        <input
          type="number"
          id="max-qtd"
          class="form-control"
          min="0"
          onchange="applyFilters()"
        >
      </div>
      <button class="btn btn-filter" onclick="applyFilters()">
        <i class="fas fa-search"></i> Filtrar
      </button>
    </div>

    <!-- Tabela -->
    <div id="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Código</th>
            <th>Produto</th>
            <th>Qtd Atual</th>
            <th>Custo Médio</th>
          </tr>
        </thead>
        <tbody id="estoque-table-body">
          <tr>
            <td colspan="4">Carregando dados...</td>
          </tr>
        </tbody>
      </table>
    </div>
   </div>

  <body> 
  <script>  

    const supabaseUrl = 'https://bhkigsipuxqgpafikglm.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoa2lnc2lwdXhxZ3BhZmlrZ2xtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDE4NDMsImV4cCI6MjA3MTM3Nzg0M30.IBHX2UHeP7foTo96MFUAZUHc40O1gyNBeKqolhhceXM';
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    // Função para formatar valores monetários
    function formatCurrency(value) {
      if (!value && value !== 0) return 'R$ 0,00';
      const num = parseFloat(String(value).replace(',', '.'));
      return 'R$ ' + num.toFixed(2).replace('.', ',');
    }

    // Função para carregar dados do estoque
    async function loadEstoque() {
      const { data, error } = await client
        .from('estoque_atual')
        .select('*')
        .order('codigo', { ascending: true });

      if (error) {
        console.error('Erro ao carregar estoque:', error.message);
        return;
      }

      updateTable(data);
    }

    // Função para atualizar a tabela com os dados
    function updateTable(data) {
      const tbody = document.getElementById('estoque-table-body');
      tbody.innerHTML = '';

      if (data.length > 0) {
        data.forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.codigo || ''}</td>
            <td>${item.produto || ''}</td>
            <td>${parseFloat(item.qtd_atual || 0).toLocaleString('pt-BR')}</td>
            <td>${formatCurrency(item.custo_medio || 0)}</td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="4">Nenhum item válido encontrado</td></tr>';
      }
    }

    // Função para aplicar filtros
    async function applyFilters() {
      const searchTerm = document.getElementById('search-term').value;
      const minQtd = document.getElementById('min-qtd').value;
      const maxQtd = document.getElementById('max-qtd').value;

      let query = client
        .from('estoque_atual')
        .select('*')
        .order('codigo', { ascending: true });

      if (searchTerm) {
        query = query.or(`codigo.ilike.%${searchTerm}%,produto.ilike.%${searchTerm}%`);
      }

      if (minQtd) {
        query = query.gte('qtd_atual', minQtd);
      }

      if (maxQtd) {
        query = query.lte('qtd_atual', maxQtd);
      }

      const { data, error } = await query;

      if (error) {
        console.error('Erro ao filtrar estoque:', error.message);
        return;
      }

      updateTable(data);
    }

    // Função para limpar filtros
    function clearFilters() {
      document.getElementById('search-term').value = '';
      document.getElementById('min-qtd').value = '';
      document.getElementById('max-qtd').value = '';
      loadEstoque();
    }

    // Função para gerar relatório
    async function generateReport() {
      const searchTerm = document.getElementById('search-term').value.trim();
      const minQtd = document.getElementById('min-qtd').value;
      const maxQtd = document.getElementById('max-qtd').value;

      let query = client
        .from('estoque_atual')
        .select('*')
        .order('codigo', { ascending: true });

      if (searchTerm) {
        query = query.or(`codigo.ilike.%${searchTerm}%,produto.ilike.%${searchTerm}%`);
      }

      if (minQtd) {
        query = query.gte('qtd_atual', minQtd);
      }

      if (maxQtd) {
        query = query.lte('qtd_atual', maxQtd);
      }

      const { data, error } = await query;

      if (error) {
        console.error('Erro ao gerar relatório:', error.message);
        return;
      }

      if (data.length === 0) {
        alert("Nenhum dado disponível para gerar o relatório.");
        return;
      }

      const wsData = data.map(item => [
        item.codigo || '',
        item.produto || '',
        parseFloat(item.qtd_atual || 0).toLocaleString('pt-BR'),
        formatCurrency(item.custo_medio || 0).replace('R$ ', '')
      ]);

      const ws = XLSX.utils.aoa_to_sheet([["Código", "Produto", "Qtd Atual", "Custo Médio"], ...wsData]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Estoque Atual");

      // Gerar o nome do arquivo com a data atual
      const today = new Date();
      const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
      const fileName = `Relatorio_Estoque_${dateString}.xlsx`;

      XLSX.writeFile(wb, fileName);
    }

    // Carregar dados ao iniciar a página
    document.addEventListener('DOMContentLoaded', loadEstoque);
  </script>
</body>
</html>

