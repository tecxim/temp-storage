<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <title>Sistema de Gest√£o de Vendas</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
<style>
  /* ===============================
     VARI√ÅVEIS GLOBAIS
  =============================== */
  :root {
    --primary-color: #2c3e50;
    --secondary-color: #34495e;
    --accent-color: #3498db;
    --success-color: #2ecc71;
    --danger-color: #e74c3c;
    --warning-color: #f1c40f;
    --light-color: #ecf0f1;
    --dark-color: #2c3e50;

    --border-radius: 6px;
    --box-shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.05);
    --box-shadow-md: 0 2px 10px rgba(0, 0, 0, 0.1);
    --box-shadow-lg: 0 5px 15px rgba(0, 0, 0, 0.15);

    --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    --font-size-sm: 0.8rem;
    --font-size-md: 0.95rem;
    --font-size-lg: 1.2rem;

    --transition-default: all 0.3s ease;
  }

  /* ===============================
     RESETE E BASE
  =============================== */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: var(--font-family);
    font-size: var(--font-size-md);
    background-color: #f5f5f5;
    color: var(--dark-color);
    line-height: 1.6;
  }

  /* ===============================
     LAYOUT PRINCIPAL
  =============================== */
  .container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 20px;
    height: calc(100vh - 40px);
  }

  @media (max-width: 1024px) {
    .container {
      grid-template-columns: 1fr;
      height: auto;
    }
  }

  /* ===============================
     PAIN√âIS E CARDS
  =============================== */
  .panel {
    background-color: #fff;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow-md);
    padding: 20px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
  }

  .panel-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--primary-color);
  }

  /* ===============================
     BOT√ïES
  =============================== */
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 500;
    transition: var(--transition-default);
  }

  .btn-primary {
    background-color: var(--accent-color);
    color: white;
  }
  .btn-primary:hover {
    background-color: #2980b9;
  }

  .btn-danger {
    background-color: var(--danger-color);
    color: white;
  }
  .btn-danger:hover {
    background-color: #c0392b;
  }

  .btn-success {
    background-color: var(--success-color);
    color: white;
  }
  .btn-success:hover {
    background-color: #27ae60;
  }

  /* ===============================
     FORMUL√ÅRIOS
  =============================== */
  .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    margin-bottom: 10px;
    font-size: var(--font-size-md);
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
  }

  /* ===============================
     TABELAS
  =============================== */
  .table-container {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 15px;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table th, .table td {
    padding: 8px;
    font-size: var(--font-size-sm);
    text-align: left;
    border-bottom: 1px solid #eee;
  }

  .table th {
    background-color: var(--light-color);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .table tr:hover {
    background-color: #f9f9f9;
  }

  /* ===============================
     BADGES
  =============================== */
  .badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 20px;
    font-size: var(--font-size-sm);
    font-weight: 500;
  }
  .badge-success {
    background-color: #d4edda;
    color: #155724;
  }
  .badge-danger {
    background-color: #f8d7da;
    color: #721c24;
  }

  /* ===============================
     TOTAIS
  =============================== */
  .totals-panel {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: auto;
  }

  .total-card {
    background-color: #fff;
    border-radius: var(--border-radius);
    padding: 15px;
    box-shadow: var(--box-shadow-sm);
  }
  .total-label {
    font-size: 0.9rem;
    color: #7f8c8d;
    margin-bottom: 5px;
  }
  .total-value {
    font-size: 1.5rem;
    font-weight: 600;
  }

  /* ===============================
     M√âTODOS DE PAGAMENTO
  =============================== */
  .payment-methods {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
  }

  .payment-method {
    flex: 1 1 calc(33.333% - 10px);
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    text-align: center;
    cursor: pointer;
    transition: var(--transition-default);
  }

  .payment-method:nth-child(1) { background-color: #f8c8dc; }
  .payment-method:nth-child(2) { background-color: #c8f8dc; }
  .payment-method:nth-child(3) { background-color: #dcf8c8; }
  .payment-method:nth-child(4) { background-color: #c8dcf8; }

  .payment-method:hover {
    border-color: var(--accent-color);
  }
  .payment-method.active {
    border-color: var(--accent-color);
    transform: scale(1.05);
  }

  /* ===============================
     MODAIS
  =============================== */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background-color: #fff;
    border-radius: var(--border-radius);
    width: 90%;
    max-width: 500px;
    padding: 20px;
    box-shadow: var(--box-shadow-lg);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .modal-title {
    font-size: 1.3rem;
    font-weight: 600;
  }

  .close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #7f8c8d;
  }

  /* ===============================
     ALERTAS
  =============================== */
  .alert {
    padding: 10px 15px;
    border-radius: var(--border-radius);
    margin-bottom: 15px;
  }
  .alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  .alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  /* ===============================
     CUPOM / RECIBO
  =============================== */
  #receiptModal .modal-content {
    width: 80%;
    max-width: 500px;
  }

  #receiptContent {
    max-height: 400px;
    overflow-y: auto;
  }

  .header {
    text-align: center;
    border-bottom: 1px dashed #000;
    margin-bottom: 10px;
  }

  .item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
  }

  .total {
    font-weight: bold;
    margin-top: 10px;
    text-align: right;
  }

  .footer {
    text-align: center;
    margin-top: 20px;
    font-size: 12px;
  }

  .print-button {
    display: block;
    width: 100%;
    padding: 10px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    margin-top: 20px;
    cursor: pointer;
  }

  /* ===============================
     OUTROS
  =============================== */
  .search-container {
    display: flex;
    gap: 10px;
  }

  .button-container {
    margin-top: 15px;
    display: flex;
    gap: 10px;
  }

  .spinner {
    display: none;
  }
</div>

</style>

<!-- Font Awesome para √≠cones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Painel de Produtos -->
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title"><i class="fas fa-boxes"></i> Produtos</h2>
        <div class="search-container">
          <input type="number" id="productQuantity" class="form-control" placeholder="Quantidade" value="1" min="1" style="max-width: 60px;">
          <input type="text" id="productSearch" class="form-control" placeholder="üîç C√≥digo do produto..." autofocus  style="max-width: 320px;">
        </div>
      </div>
        <div id="noProductFound" style="display: none; color: #a94442; font-weight: 500;">      
        <i class="fas fa-search"></i>
        <p>Nenhum produto encontrado. Digite o c√≥digo ou nome do produto.</p>
      </div>
          <div style="margin-top: 20px;">
      <h3><i class="fas fa-credit-card"></i> M√©todo de Pagamento</h3>
      <div class="payment-methods" id="paymentMethods">
        <div class="payment-method" data-method="Dinheiro">
          <i class="fas fa-money-bill-wave"></i>
          <span>Dinheiro</span>
        </div>
        <div class="payment-method" data-method="PIX">
          <i class="fas fa-qrcode"></i>
          <span>PIX</span>
        </div>
        <div class="payment-method" data-method="Cart√£o D√©bito">
          <i class="fas fa-credit-card"></i>
          <span>Cart√£o D√©bito</span>
        </div>
        <div class="payment-method" data-method="Cart√£o Cr√©dito">
          <i class="far fa-credit-card"></i>
          <span>Cart√£o Cr√©dito</span>
        </div>
        <div class="payment-method" data-method="Transfer√™ncia Banc√°ria">
          <i class="fas fa-exchange-alt"></i>
          <span>Transfer√™ncia</span>
        </div>
        <div class="payment-method" data-method="Boleto">
          <i class="fas fa-barcode"></i>
          <span>Boleto</span>
        </div>
        <div class="payment-method" data-method="Cheque">
          <i class="fas fa-money-check"></i>
          <span>Cheque</span>
        </div>
        <div class="payment-method" data-method="Carteira Digital">
          <i class="fas fa-mobile-alt"></i>
          <span>Carteira Digital</span>
        </div>
      </div>
    </div>
    </div>

    <!-- Painel do Carrinho -->
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title"><i class="fas fa-shopping-cart"></i> Carrinho de Venda</h2>
        <button id="clearCart" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Limpar</button>
      </div>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Produto</th>
              <th>Qtd</th>
              <th>Pre√ßo</th>
              <th>Total</th>
              <th>A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="cartItems"></tbody>
        </table>
      </div>
      <div class="totals-panel">
        <div class="total-card">
          <div class="total-label">Subtotal</div>
          <div class="total-value" id="subtotal">R$ 0,00</div>
        </div>
        <div class="total-card">
          <div class="total-label">Desconto</div>
          <div class="total-value" id="discount">0%</div>
        </div>
        <div class="total-card">
          <div class="total-label">Total</div>
          <div class="total-value" id="total">R$ 0,00</div>
        </div>
      </div>
      <div class="button-container">
        <button id="applyDiscount" class="btn btn-primary"><i class="fas fa-percentage"></i> Desconto</button>
        <button id="finalizeSale" class="btn btn-success"><i class="fas fa-check-circle"></i> Finalizar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Desconto -->
  <div class="modal" id="discountModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-percentage"></i> Aplicar Desconto</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="form-group">
        <label for="discountValue" class="form-label">Percentual de Desconto (%)</label>
        <input type="number" id="discountValue" class="form-control" min="0" max="100" value="0">
      </div>
      <button id="confirmDiscount" class="btn btn-primary" style="width: 100%;">
        <i class="fas fa-check"></i> Aplicar Desconto
      </button>
    </div>
  </div>

  <!-- Modal de Confirma√ß√£o -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-check-circle"></i> Venda Conclu√≠da</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div id="confirmContent">
        <div class="alert alert-success">
          <p><i class="fas fa-check-circle"></i> Venda finalizada com sucesso!</p>
          <p><strong><i class="fas fa-receipt"></i> N√∫mero da venda:</strong> <span id="saleId"></span></p>
          <p><strong><i class="fas fa-money-bill-wave"></i> Total:</strong> <span id="saleTotal"></span></p>
        </div>
        <div class="button-container">
          <button id="printReceipt" class="btn btn-primary">
            <i class="fas fa-print"></i> Imprimir Cupom
          </button>
          <button id="newSale" class="btn">
          <i class="fas fa-plus-circle"></i> Nova Venda
        </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal do Cupom -->
  <div class="modal" id="receiptModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-receipt"></i> Cupom N√£o Fiscal</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div id="receiptContent"></div>
      <button id="printReceiptFromModal" class="print-button">
        <i class="fas fa-print"></i> Imprimir Cupom
      </button>
    </div>
  </div>

  <!-- Modal de Troco -->
  <div class="modal" id="changeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-calculator"></i> Calcular Troco</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="form-group">
        <label for="amountReceived" class="form-label">Valor Recebido (R$)</label>
        <input type="number" id="amountReceived" class="form-control" min="0" step="0.01" placeholder="0,00">
      </div>
      <div class="form-group">
        <label for="totalAmount" class="form-label">Total da Compra (R$)</label>
        <input type="number" id="totalAmount" class="form-control" readonly>
      </div>
      <div class="form-group">
        <label for="changeAmount" class="form-label">Troco (R$)</label>
        <input type="text" id="changeAmount" class="form-control" readonly style="font-weight: bold; color: var(--success-color);">
      </div>
      <button id="confirmChange" class="btn btn-primary" style="width: 100%;">
        <i class="fas fa-check"></i> Confirmar Pagamento
      </button>
    </div>
  </div>

  <script>
      const supabaseUrl = 'https://bhkigsipuxqgpafikglm.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoa2lnc2lwdXhxZ3BhZmlrZ2xtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDE4NDMsImV4cCI6MjA3MTM3Nzg0M30.IBHX2UHeP7foTo96MFUAZUHc40O1gyNBeKqolhhceXM';
      const client  = supabase.createClient(supabaseUrl, supabaseKey);

    // Vari√°veis globais
    let cart = [];
    let currentDiscount = 0;
    let selectedPaymentMethod = null;
    let stockData = [];

    const elements = {
      productSearch: document.getElementById('productSearch'),
      productQuantity: document.getElementById('productQuantity'),
      cartItems: document.getElementById('cartItems'),
      clearCart: document.getElementById('clearCart'),
      applyDiscount: document.getElementById('applyDiscount'),
      finalizeSale: document.getElementById('finalizeSale'),
      subtotalEl: document.getElementById('subtotal'),
      discountEl: document.getElementById('discount'),
      totalEl: document.getElementById('total'),
      paymentMethodsEl: document.getElementById('paymentMethods'),
      discountModal: document.getElementById('discountModal'),
      discountValue: document.getElementById('discountValue'),
      confirmDiscount: document.getElementById('confirmDiscount'),
      confirmModal: document.getElementById('confirmModal'),
      saleIdEl: document.getElementById('saleId'),
      saleTotalEl: document.getElementById('saleTotal'),
      changeModal: document.getElementById('changeModal'),
      amountReceived: document.getElementById('amountReceived'),
      totalAmount: document.getElementById('totalAmount'),
      confirmChange: document.getElementById('confirmChange'),
      changeAmount: document.getElementById('changeAmount'), // Adicione esta linha
    };

    elements.amountReceived.addEventListener('input', function() {
      const amountReceived = parseFloat(String(elements.amountReceived.value).replace(',', '.')) || 0;
      const totalAmount = parseFloat(String(elements.totalAmount.value).replace(',', '.')) || 0;
      const changeAmount = amountReceived - totalAmount;
      elements.changeAmount.value = changeAmount >= 0 ? changeAmount.toFixed(2).replace('.', ',') : "0,00";
    });



    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', async function() {
      setupEventListeners();
      await loadStockData();
      loadPaymentMethods();
      renderCart();
      elements.productSearch.focus();
    });


   //*************************************************************************

    function setupEventListeners() {
        elements.productSearch.addEventListener('keyup', async function(event) {
            if (event.key === 'Enter') {
                await handleProductSearch();
            }
        });

        elements.clearCart.addEventListener('click', handleClearCart);
        elements.applyDiscount.addEventListener('click', handleOpenDiscountModal);
        elements.confirmDiscount.addEventListener('click', handleApplyDiscount);
        elements.finalizeSale.addEventListener('click', handleFinalizeSale);
        elements.confirmChange.addEventListener('click', handleConfirmChange);

        // Adiciona o listener para calcular o troco automaticamente
        elements.amountReceived.addEventListener('input', function() {
          const amountReceived = parseFloat(
            elements.amountReceived.value.replace(',', '.')
          ) || 0;

          const totalAmount = parseFloat(
            elements.totalAmount.value.replace(',', '.')
          ) || 0;

          const changeAmount = amountReceived - totalAmount;

          console.log("Valor Recebido:", amountReceived);
          console.log("Total da Compra:", totalAmount);
          console.log("Troco Calculado:", changeAmount);

          elements.changeAmount.value = changeAmount >= 0 ? changeAmount.toFixed(2).replace('.', ',') : "0,00";
        });

        // Adiciona o listener para fechar as modais
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            });
        });

        // Adiciona o listener para o bot√£o "Nova Venda"
        const newSaleButton = document.getElementById('newSale');
        if (newSaleButton) {
            newSaleButton.addEventListener('click', () => {
                const confirmModal = document.getElementById('confirmModal');
                if (confirmModal) {
                    confirmModal.style.display = 'none';
                }
                newSale();
            });
        }

        // Adiciona o listener para o bot√£o "Imprimir Cupom" na modal
        const printReceiptButton = document.getElementById('printReceipt');
        if (printReceiptButton) {
            printReceiptButton.addEventListener('click', async function() {
                const saleId = elements.saleIdEl.textContent;
                const totalText = elements.saleTotalEl.textContent;
                const total = parseFloat(
                    totalText
                        .replace('R$', '')
                        .trim()
                        .replace(/\./g, '')
                        .replace(',', '.')
                );

                // Busca os itens da venda atual
                const { data: items, error } = await client
                    .from('itens_venda')
                    .select('*')
                    .eq('id_venda', saleId);

                if (error) {
                    console.error("Erro ao buscar itens da venda:", error);
                    alert("Erro ao buscar itens da venda.");
                    return;
                }

                // Busca os dados do pagamento
                const { data: paymentData, error: paymentError } = await client
                    .from('pagamentos')
                    .select('valor_recebido, troco, forma_pagamento')
                    .eq('id_venda', saleId)
                    .limit(1);

                if (paymentError) {
                    console.error("Erro ao buscar dados do pagamento:", paymentError);
                    alert("Erro ao buscar dados do pagamento.");
                    return;
                }

                const receivedValue = paymentData[0]?.valor_recebido || "0.00";
                const change = paymentData[0]?.troco || "0.00";
                const paymentMethod = paymentData[0]?.forma_pagamento || "DINHEIRO";

                // Chama a fun√ß√£o de impress√£o
                await printReceipt(saleId, items, total, paymentMethod, receivedValue, change);
            });
        }
    }



    //*************************************************************************


    // Carregar dados de estoque
    async function loadStockData() {
      try {
        const { data, error } = await client
          .from('movimentacoes_estoque')
          .select('*');

        if (error) throw error;

        const productMap = {};
        data.forEach(row => {
          const code = row.codigo;
          const name = row.produto;
          const type = row.tipo;
          const quantity = parseFloat(row.qtde) || 0;
          const price = parseFloat(row.custo_unitario) || 0;

          if (!code || !name) return;

          if (!productMap[code]) {
            productMap[code] = {
              code: code,
              name: name,
              price: price,
              quantity: 0
            };
          }

          if (type === 'Entrada') {
            productMap[code].quantity += quantity;
          } else if (type === 'Sa√≠da') {
            productMap[code].quantity -= quantity;
          }
        });

        stockData = Object.values(productMap).filter(p => p.quantity > 0);
      } catch (error) {
        console.error("Erro ao carregar estoque:", error);
      }
    }

    //*************************************************************************


    async function handleProductSearch() {
      const searchTerm = elements.productSearch.value.trim();
      const noProductFound = document.getElementById("noProductFound");
    
      // Oculta a mensagem sempre que iniciar uma nova busca
      noProductFound.style.display = "none";
    
      if (!searchTerm) {
        alert('Digite um c√≥digo ou nome de produto para buscar.');
        return;
      }
    
      try {
        const { data: entradas, error } = await client
          .from('movimentacoes_estoque')
          .select('codigo, produto, custo_unitario, qtde, data')
          .or(`codigo.eq.${searchTerm},produto.ilike.%${searchTerm}%`)
          .eq('tipo', 'Entrada')
          .gt('qtde', 0)
          .order('data', { ascending: true });
    
        if (error) throw error;
    
        if (entradas.length === 0) {
          // Mostra a mensagem no lugar do alert
          noProductFound.style.display = "block";
          return;
        }
    
        // Agrupa entradas
        const produtosDisponiveis = {};
        entradas.forEach(entrada => {
          const codigo = entrada.codigo;
          if (!produtosDisponiveis[codigo]) {
            produtosDisponiveis[codigo] = {
              codigo: codigo,
              nome: entrada.produto,
              entradas: [],
              estoqueTotal: 0
            };
          }
          produtosDisponiveis[codigo].entradas.push({
            custo_unitario: parseFloat(entrada.custo_unitario),
            quantidade: parseFloat(entrada.qtde),
            data: entrada.data
          });
          produtosDisponiveis[codigo].estoqueTotal += parseFloat(entrada.qtde);
        });
    
        const produtoKey = Object.keys(produtosDisponiveis)[0];
        const produto = produtosDisponiveis[produtoKey];
        const quantity = parseInt(elements.productQuantity.value) || 1;
    
        if (quantity <= 0) {
          alert('Quantidade inv√°lida.');
          return;
        }
    
        if (produto.estoqueTotal < quantity) {
          alert(`Estoque insuficiente. Dispon√≠vel: ${produto.estoqueTotal}`);
          return;
        }
    
        addProductToCart({
          code: produto.codigo,
          name: produto.nome,
          price: produto.entradas[0].custo_unitario
        }, quantity);
    
      } catch (error) {
        console.error("Erro ao buscar produto:", error);
        alert('Erro ao buscar produto. Tente novamente.');
      }
    }

    
    //*************************************************************************

    // Adicionar produto ao carrinho
    function addProductToCart(product, quantity) {
      const existingIndex = cart.findIndex(item => item.code === product.code);
      if (existingIndex >= 0) {
        cart[existingIndex].quantity += quantity;
      } else {
        cart.push({
          code: product.code,
          name: product.name,
          price: product.price,
          quantity: quantity
        });
      }

      renderCart();
      elements.productSearch.value = '';
      elements.productQuantity.value = '1';
      elements.productSearch.focus();
    }

  //*************************************************************************


    // Renderizar carrinho
    function renderCart() {
      const fragment = document.createDocumentFragment();
      if (cart.length === 0) {
        elements.cartItems.innerHTML = '<tr><td colspan="5" class="text-center">Carrinho vazio</td></tr>';
        updateTotals(0);
        return;
      }

      let subtotal = 0;
      elements.cartItems.innerHTML = '';

      cart.forEach((item, index) => {
        const row = document.createElement('tr');
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;

        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td>R$ ${item.price.toFixed(2)}</td>
          <td>R$ ${itemTotal.toFixed(2)}</td>
          <td>
            <button class="btn btn-danger remove-item" data-index="${index}">
              Remover
            </button>
          </td>
        `;

        row.querySelector('.remove-item').addEventListener('click', () => {
          removeItemFromCart(index);
        });

        fragment.appendChild(row);
      });

      elements.cartItems.appendChild(fragment);
      updateTotals(subtotal);
    }

  //*************************************************************************


    // Remover item do carrinho
    function removeItemFromCart(index) {
      if (index >= 0 && index < cart.length) {
        cart.splice(index, 1);
        renderCart();
      }
    }

    // Atualizar totais
    function updateTotals(subtotal) {
      const discountAmount = subtotal * (currentDiscount / 100);
      const total = subtotal - discountAmount;

      elements.subtotalEl.textContent = `R$ ${subtotal.toFixed(2)}`;
      elements.discountEl.textContent = `${currentDiscount}%`;
      elements.totalEl.textContent = `R$ ${total.toFixed(2)}`;
    }


  //*************************************************************************

    // Carregar m√©todos de pagamento
    function loadPaymentMethods() {
      const predefinedMethods = [
        { method: 'Dinheiro', icon: 'money-bill-wave' },
        { method: 'PIX', icon: 'qrcode' },
        { method: 'Cart√£o D√©bito', icon: 'credit-card' },
        { method: 'Cart√£o Cr√©dito', icon: 'credit-card' },
        { method: 'Transfer√™ncia Banc√°ria', icon: 'exchange-alt' },
        { method: 'Boleto', icon: 'barcode' },
        { method: 'Cheque', icon: 'money-check' },
        { method: 'Carteira Digital', icon: 'mobile-alt' }
      ];

      elements.paymentMethodsEl.innerHTML = '';
      predefinedMethods.forEach(method => {
        const methodEl = document.createElement('div');
        methodEl.className = 'payment-method';
        methodEl.setAttribute('data-method', method.method);
        methodEl.innerHTML = `
          <i class="fas fa-${method.icon}"></i>
          <span>${method.method}</span>
        `;

        methodEl.addEventListener('click', () => {
          selectedPaymentMethod = method.method;
          document.querySelectorAll('.payment-method').forEach(el => {
            el.classList.remove('active');
          });
          methodEl.classList.add('active');
        });

        elements.paymentMethodsEl.appendChild(methodEl);
      });
    }

    //*************************************************************************


    // Aplicar desconto
    function handleOpenDiscountModal() {
      if (cart.length === 0) {
        alert("Adicione produtos ao carrinho antes de aplicar desconto");
        return;
      }
      elements.discountValue.value = currentDiscount;
      elements.discountModal.style.display = 'flex';
    }

    function handleApplyDiscount() {
      const discount = parseInt(elements.discountValue.value);
      if (isNaN(discount)) {
        alert("Por favor, insira um valor num√©rico");
        return;
      }
      if (discount < 0 || discount > 100) {
        alert("O desconto deve estar entre 0% e 100%");
        return;
      }
      currentDiscount = discount;
      elements.discountModal.style.display = 'none';
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      updateTotals(subtotal);
    }

    //*************************************************************************


    // Limpar carrinho
    function handleClearCart() {
      if (cart.length === 0) return;
      if (confirm("Deseja realmente limpar o carrinho?")) {
        cart = [];
        currentDiscount = 0;
        renderCart();
        elements.productSearch.focus();
      }
    }

    // Verificar estoque
    async function checkStockByBarcode(cart) {
      const lowStockItems = [];
      for (const item of cart) {
        const { data: entradas, error } = await client
          .from('movimentacoes_estoque')
          .select('*')
          .eq('codigo', item.code)
          .eq('tipo', 'Entrada')
          .gt('qtde', 0);

        if (error) throw error;
        if (entradas.length === 0) {
          lowStockItems.push(item.code);
        }
      }
      return lowStockItems;
    }

    function formatCurrentDateTime() {
      const now = new Date();
      const year = now.getFullYear();
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');

      // A data ser√° salva neste formato para garantir a ordena√ß√£o correta
      return `${year}-${month}-${day} ${hours}:${minutes}`;
  }


//*************************************************************************

async function applyFIFOAndRegisterExit(codigoBarras, quantidadeVendida, dataVenda) {
    try {
        const { data: lotesDisponiveis, error } = await client
            .from('movimentacoes_estoque')
            .select('id, qtde, custo_unitario, produto, data')
            .eq('codigo', codigoBarras)
            .eq('tipo', 'Entrada')
            .gt('qtde', 0)
            .order('data', { ascending: true });

        if (error) {
            console.error("Erro ao buscar lotes para FIFO:", error.message);
            throw error;
        }

        let quantidadeRestante = quantidadeVendida;
        let custoUnitario = 0;

        for (const lote of lotesDisponiveis) {
            if (quantidadeRestante <= 0) break;

            const quantidadeUtilizada = Math.min(lote.qtde, quantidadeRestante);

            await client
                .from('estoque_saida')
                .insert({
                    codigo: codigoBarras,
                    data_saida: dataVenda,
                    produto: lote.produto,
                    tipo: 'saida',
                    qtde: quantidadeUtilizada,
                    custo_unitario: lote.custo_unitario,
                    origem: 'Venda',
                });

            custoUnitario = lote.custo_unitario; // Pega o custo unit√°rio do lote atual

            quantidadeRestante -= quantidadeUtilizada;

            await client
                .from('movimentacoes_estoque')
                .update({ qtde: lote.qtde - quantidadeUtilizada })
                .eq('id', lote.id);
        }

        if (quantidadeRestante > 0) {
            console.warn(`Aviso: Falta de estoque para ${codigoBarras}. Quantidade n√£o atendida: ${quantidadeRestante}`);
        }

        return custoUnitario; // Retorna o custo unit√°rio do lote utilizado
    } catch (error) {
        console.error("Erro na fun√ß√£o applyFIFOAndRegisterExit:", error.message);
        throw error;
    }
}

//*************************************************************************


async function registerSale(items, paymentMethod, discount = 0) {
    const saleId = Math.random().toString(36).substring(2, 10).toUpperCase();
    const now = formatCurrentDateTime();

    // 1. Buscar taxa do m√©todo de pagamento
    const { data: metodoData, error: metodoError } = await client
        .from('metodo_pagamento')
        .select('taxas')
        .eq('metodo', paymentMethod)
        .limit(1);
    if (metodoError) throw metodoError;
    const taxa = metodoData && metodoData.length > 0
        ? parseFloat(metodoData[0].taxas) || 0
        : 0;

    // 2. Calcular totais
    const subtotal = items.reduce(
        (sum, item) => sum + (parseFloat(item.price) * parseFloat(item.quantity)), 0
    );
    const totalDiscount = subtotal * (parseFloat(discount) / 100);
    const totalSemTaxa = subtotal - totalDiscount;
    const valorTaxa = totalSemTaxa * (taxa / 100);
    const totalComTaxa = totalSemTaxa + valorTaxa;

    // 3. Aplicar FIFO e obter custos unit√°rios
    const custosPorItem = {};
    for (const item of items) {
        const custoUnitario = await applyFIFOAndRegisterExit(item.code, parseFloat(item.quantity), now);
        custosPorItem[item.code] = custoUnitario; // N√£o √© necess√°rio parseFloat
    }

    // 4. Registrar itens da venda com custo unit√°rio
    const itemRows = items.map(item => ({
        codigo: item.code,
        id_venda: saleId,
        data_venda: now,
        item: `${item.name} (${item.quantity}x)`,
        quantidade: parseFloat(item.quantity),
        preco_unitario: parseFloat(item.price),
        custo_unitario: custosPorItem[item.code] || 0, // Valor j√° √© num√©rico
        total: (parseFloat(item.price) * parseFloat(item.quantity)).toFixed(2),
        valor_desconto: ((parseFloat(item.price) * parseFloat(item.quantity)) / subtotal * totalDiscount).toFixed(2),
        status: 'FINALIZADA',
        metodo_pagamento: paymentMethod
    }));

    // 5. Gravar itens da venda
    const { error: itemsError } = await client
        .from('itens_venda')
        .insert(itemRows);
    if (itemsError) throw itemsError;

    // 6. Registrar pagamento
    const { error: paymentError } = await client
        .from('pagamentos')
        .insert([{
            id_venda: saleId,
            valor_recebido: "0.00",
            total: totalComTaxa.toFixed(2),
            troco: "0.00",
            forma_pagamento: paymentMethod,
            data_pagto: now,
        }]);
    if (paymentError) throw paymentError;

    // 7. Imprimir cupom automaticamente
    await printReceipt(saleId, items, totalComTaxa.toFixed(2), paymentMethod);
    return saleId;
}

 //*************************************************************************


    // Fun√ß√£o para formatar valor monet√°rio
  function formatCurrency(value) {
        return `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
    }

   async function getCompanyData() {
    try {
        const { data, error } = await client
            .from('dados_empresa')
            .select('razao_social, cnpj, cidade, uf, contato, endereco')
            .limit(1);
        if (error) {
            console.error("Erro ao buscar dados da empresa:", error);
            return {
                razao_social: "Nome da Empresa",
                cnpj: "00.000.000/0000-00",
                cidade: "Cidade",
                uf: "UF",
                contato: "(00) 0000-0000",
                endereco: "Endere√ßo Padr√£o"
            };
        }
        return data[0] || {
            razao_social: "Nome da Empresa",
            cnpj: "00.000.000/0000-00",
            cidade: "Cidade",
            uf: "UF",
            contato: "(00) 0000-0000",
            endereco: "Endere√ßo Padr√£o"
        };
    } catch (error) {
        console.error("Erro ao buscar dados da empresa:", error);
        return {
            razao_social: "Nome da Empresa",
            cnpj: "00.000.000/0000-00",
            cidade: "Cidade",
            uf: "UF",
            contato: "(00) 0000-0000",
            endereco: "Endere√ßo Padr√£o"
        };
    }
}

 //*************************************************************************

async function printReceipt(saleId, items, total, paymentMethod, receivedValue = "0.00", change = "0.00") {
    try {
        const company = await getCompanyData();
        const now = new Date();
        const formattedDate = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

        // Fun√ß√£o para formatar valores monet√°rios
        const formatCurrencyValue = (value) => {
            return parseFloat(value).toFixed(2).replace('.', ',');
        };

        // Fun√ß√£o para quebrar texto em linhas de at√© um certo n√∫mero de caracteres
        const breakText = (text, maxLength = 20) => {
            if (!text) return "";
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                if (currentLine.length + words[i].length + 1 <= maxLength) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines.join('<br>');
        };

        // Abre uma nova janela para impress√£o
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Cupom N√£o Fiscal</title>
                <style>
                    body {
                        font-family: monospace;
                        width: 80mm;
                        margin: 0;
                        padding: 0;
                        font-size: 11px;
                        line-height: 1.1;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 3px;
                    }
                    .company-info {
                        text-align: center;
                        margin-bottom: 3px;
                    }
                    .sale-info {
                        text-align: left;
                        margin-left: 2px;
                        margin-bottom: 3px;
                    }
                    .item-header {
                        display: flex;
                        justify-content: space-between;
                        margin-left: 2px;
                        margin-right: 2px;
                        font-weight: bold;
                        border-bottom: 1px dashed #000;
                        padding-bottom: 2px;
                        margin-bottom: 2px;
                    }
                    .item-line {
                        display: flex;
                        justify-content: space-between;
                        margin-left: 2px;
                        margin-right: 2px;
                    }
                    .item-name {
                        flex: 1;
                        max-width: 50%;
                        word-break: break-word;
                        text-align: left;
                    }
                    .item-quantity-unit {
                        text-align: right;
                        width: 30%;
                    }
                    .item-total {
                        text-align: right;
                        width: 20%;
                    }
                    .divider {
                        border-bottom: 1px dashed #000;
                        margin: 2px 0;
                    }
                    .footer {
                        text-align: center;
                        margin-top: 5px;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <p><strong>Cupom N√£o Fiscal</strong></p>
                    <p>${formattedDate}</p>
                </div>
                <div class="company-info">
                    <p>${breakText(company.razao_social || "Nome da Empresa")}</p>
                    <p>${breakText(company.endereco || "Endere√ßo Padr√£o")}, ${breakText(company.cidade || "Cidade")}-${company.uf || "UF"}</p>
                    <p>CNPJ: ${company.cnpj || "00.000.000/0000-00"}</p>
                    <p>Contato: ${company.contato || "(00) 0000-0000"}</p>
                </div>
                <div class="sale-info">
                    <p><strong>ID Venda:</strong> ${saleId}</p>
                </div>
                <div class="divider"></div>
                <div class="item-header">
                    <span class="item-name">Item</span>
                    <span class="item-quantity-unit">Qtde x Unit</span>
                    <span class="item-total">Total</span>
                </div>
                <div class="body">
        `);

        // Adiciona os itens ao corpo do cupom
        items.forEach(item => {
            const itemName = breakText(item.name || item.item || "Item", 20);
            const quantity = item.quantity || item.quantidade || 1;
            const unitPrice = formatCurrencyValue(item.price || item.preco_unitario || 0);
            const totalPrice = formatCurrencyValue((parseFloat(item.price || item.preco_unitario || 0) * parseFloat(quantity)).toFixed(2));

            printWindow.document.write(`
                <div class="item-line">
                    <span class="item-name">${itemName}</span>
                    <span class="item-quantity-unit">${quantity}x${unitPrice}</span>
                    <span class="item-total">${totalPrice}</span>
                </div>
            `);
        });

        printWindow.document.write(`
                </div>
                <div class="divider"></div>
                <div class="footer">
                    <p><strong>Total: R$ ${formatCurrencyValue(total)}</strong></p>
                    <p>Valor Recebido: R$ ${formatCurrencyValue(receivedValue)}</p>
                    <p>Troco: R$ ${formatCurrencyValue(change)}</p>
                    <p>Forma de Pagamento: ${paymentMethod}</p>
                </div>
                <div class="divider"></div>
                <div class="footer">
                    <p>Obrigado pela prefer√™ncia!</p>
                </div>
            </body>
            </html>
        `);

        // Fecha o documento e imprime
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    } catch (error) {
        console.error("Erro ao imprimir cupom:", error);
        alert("Erro ao imprimir cupom. Tente novamente.");
    }
}


//*************************************************************************


function newSale() {
    // 1. Limpa os campos
    elements.productSearch.value = '';
    elements.productQuantity.value = 1;
    // ... l√≥gica para limpar o carrinho ...

    // 2. Fecha a modal de confirma√ß√£o
    const modal = document.getElementById('confirmModal');
    if (modal) {
        modal.style.display = 'none';
    }

    // 3. Foca no campo de busca
    elements.productSearch.focus();
}

//*************************************************************************

    async function handleFinalizeSale() {
        if (!selectedPaymentMethod) return alert("Selecione um m√©todo de pagamento");
        if (cart.length === 0) return alert("Adicione produtos ao carrinho"), elements.productSearch.focus();

        const { data: metodoData, error: metodoError } = await client
            .from('metodo_pagamento')
            .select('taxas')
            .eq('metodo', selectedPaymentMethod)
            .limit(1);

        if (metodoError) return console.error("Erro ao buscar taxa:", metodoError), alert("Erro ao buscar taxa do m√©todo de pagamento");

        const taxa = metodoData?.[0]?.taxas ? parseFloat(metodoData[0].taxas) : 0;
        const lowStockItems = await checkStockByBarcode(cart);

        if (lowStockItems.length > 0 && !confirm(`Itens com estoque insuficiente: ${lowStockItems.join(', ')}. Continuar?`)) return;

        const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) * parseFloat(item.quantity)), 0);
        const totalDiscount = subtotal * (currentDiscount / 100);
        const totalComTaxa = (subtotal - totalDiscount) * (1 + taxa / 100);

        if (selectedPaymentMethod === 'Dinheiro') {
            elements.totalAmount.value = totalComTaxa.toFixed(2);
            return elements.changeModal.style.display = 'flex';
        }

        try {
            const saleId = await registerSale(cart, selectedPaymentMethod, currentDiscount);
            showSaleConfirmation({
                saleId,
                transactionId: saleId,
                date: new Date(),
                items: cart,
                subtotal: subtotal.toFixed(2),
                totalDiscount: totalDiscount.toFixed(2),
                taxa,
                valorTaxa: (totalComTaxa - subtotal + totalDiscount).toFixed(2),
                total: totalComTaxa.toFixed(2),
                paymentMethod: selectedPaymentMethod
            });
            cart = [];
            currentDiscount = 0;
            renderCart();
        } catch (error) {
            alert(`Erro ao finalizar venda: ${error.message}`);
            console.error("Erro na venda:", error);
        }
    }

  //*************************************************************************


    // Confirmar troco
function handleConfirmChange() {
  const amountReceived = parseFloat(elements.amountReceived.value);
  const totalAmount = parseFloat(elements.totalAmount.value);

  if (isNaN(amountReceived) || amountReceived <= 0) {
    alert("Por favor, insira um valor recebido v√°lido.");
    return;
  }

  const changeAmount = amountReceived - totalAmount;

  if (changeAmount < 0) {
    alert("O valor recebido √© menor que o total da compra.");
    return;
  }

  registerSale(cart, selectedPaymentMethod, currentDiscount)
    .then(saleId => {
      const saleData = {
        saleId: saleId,
        transactionId: saleId,
        date: new Date(),
        items: cart,
        subtotal: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2),
        totalDiscount: (cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * (currentDiscount / 100)).toFixed(2),
        total: (cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) - (cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * (currentDiscount / 100))).toFixed(2),
        paymentMethod: selectedPaymentMethod,
        amountReceived: amountReceived.toFixed(2),
        changeAmount: changeAmount.toFixed(2)
      };

      // Chamada para imprimir o cupom com os valores de troco e valor recebido
      printReceipt(
        saleData.saleId,
        saleData.items,
        saleData.total,
        saleData.paymentMethod,
        saleData.amountReceived,
        saleData.changeAmount
      );

      showSaleConfirmation(saleData);
      cart = [];
      currentDiscount = 0;
      renderCart();
    })
    .catch(error => {
      alert(`Erro ao finalizar venda: ${error.message}`);
      console.error("Erro na venda:", error);
    });

  elements.changeModal.style.display = 'none';
}


    function showSaleConfirmation(result) {
  if (elements.saleIdEl) {
    elements.saleIdEl.textContent = result.transactionId;
  }

  if (elements.saleTotalEl) {
    elements.saleTotalEl.textContent = `R$ ${result.total}`;
  }

  // Verifique se os elementos existem antes de definir o textContent
  if (elements.amountReceivedEl) {
    elements.amountReceivedEl.textContent = `Valor Recebido: R$ ${result.amountReceived}`;
  }

  if (elements.changeAmountEl) {
    elements.changeAmountEl.textContent = `Troco: R$ ${result.changeAmount}`;
  }

  if (elements.confirmModal) {
    elements.confirmModal.style.display = 'flex';
  }
}


</script>

</body>
</html>
