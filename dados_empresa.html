
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro da Empresa</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        .company-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .modal-content {
            border-radius: 15px;
            overflow: hidden;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }
        .btn-action {
            transition: all 0.2s ease;
        }
        .btn-action:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col">
                <h1 class="text-center text-primary"><i class="bi bi-buildings-fill me-2"></i>Cadastro da Empresa</h1>
                <p class="text-center text-muted">Gerencie as informações das empresas cadastradas</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col d-flex justify-content-between align-items-center">
                <h2>Informações</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#companyModal" onclick="openModal()">
                    <i class="bi bi-plus-circle me-1"></i> Nova Empresa
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div id="loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando empresas...</p>
                </div>
                <div id="companies-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
                <div id="empty-state" class="text-center py-5 d-none">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h3 class="text-muted mt-3">Nenhuma empresa cadastrada</h3>
                    <p class="text-muted">Clique no botão "Nova Empresa" para adicionar a primeira.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar/editar empresa -->
    <div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="companyModalLabel">Adicionar Nova Empresa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="companyForm">
                        <input type="hidden" id="companyId">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="razao_social" class="form-label">Razão Social</label>
                                <input type="text" class="form-control" id="razao_social" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cnpj" class="form-label">CNPJ</label>
                                <input type="text" class="form-control" id="cnpj" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="contato" class="form-label">Contato</label>
                                <input type="text" class="form-control" id="contato" required>
                            </div>
                            <div class="col-md-8 mb-3">
                                <label for="endereco" class="form-label">Endereço</label>
                                <input type="text" class="form-control" id="endereco" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cidade" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="cidade" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="uf" class="form-label">UF</label>
                                <select class="form-select" id="uf" required>
                                    <option value="">Selecione...</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AM">AM</option>
                                    <option value="AP">AP</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MG">MG</option>
                                    <option value="MS">MS</option>
                                    <option value="MT">MT</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="PR">PR</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="RS">RS</option>
                                    <option value="SC">SC</option>
                                    <option value="SE">SE</option>
                                    <option value="SP">SP</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="deleteButton" style="display: none;" onclick="deleteCompany()">Excluir</button>
                    <button type="button" class="btn btn-primary" onclick="saveCompany()">Salvar Empresa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <script>
        const supabaseUrl = 'https://bhkigsipuxqgpafikglm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoa2lnc2lwdXhxZ3BhZmlrZ2xtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDE4NDMsImV4cCI6MjA3MTM3Nzg0M30.IBHX2UHeP7foTo96MFUAZUHc40O1gyNBeKqolhhceXM';
        const client = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Variáveis globais
        let companies = [];
        let editingId = null;
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadCompanies();
            
            // Configurar máscara para CNPJ
            $('#cnpj').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length > 14) value = value.slice(0, 14);
                
                if (value.length > 12) {
                    value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                } else if (value.length > 8) {
                    value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})/, '$1.$2.$3/$4');
                } else if (value.length > 5) {
                    value = value.replace(/^(\d{2})(\d{3})(\d{3})/, '$1.$2.$3');
                } else if (value.length > 2) {
                    value = value.replace(/^(\d{2})(\d{3})/, '$1.$2');
                }
                $(this).val(value);
            });
        });
        
            // Carregar empresas do Supabase
    async function loadCompanies() {
        try {
            const { data, error } = await client
                .from('dados_empresa')
                .select('*')
                .order('razao_social');
            
            if (error) throw error;
            
            companies = data || [];
            renderCompanies();
            
            // Ocultar loading e mostrar container
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('companies-container').classList.remove('d-none');
            
            // DESABILITAR BOTÃO SE JÁ HOUVER REGISTRO
            const newCompanyBtn = document.querySelector('[data-bs-target="#companyModal"]');
            if (companies.length > 0) {
                newCompanyBtn.disabled = true;
                newCompanyBtn.classList.add('disabled');
                newCompanyBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Limite atingido (1/1)';
            } else {
                newCompanyBtn.disabled = false;
                newCompanyBtn.classList.remove('disabled');
                newCompanyBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Nova Empresa';
            }
            
            if (companies.length === 0) {
                document.getElementById('empty-state').classList.remove('d-none');
            } else {
                document.getElementById('empty-state').classList.add('d-none');
            }
        } catch (error) {
            console.error('Erro ao carregar empresas:', error);
            alert('Erro ao carregar empresas. Verifique o console para mais detalhes.');
        }
    }

    // Salvar empresa (criar ou atualizar) - VERSÃO ATUALIZADA
    async function saveCompany() {
        // Validação básica
        const form = document.getElementById('companyForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Coletar e validar dados
        const razaoSocial = document.getElementById('razao_social').value.trim();
        const cnpj = document.getElementById('cnpj').value.replace(/\D/g, '');
        const endereco = document.getElementById('endereco').value.trim();
        const cidade = document.getElementById('cidade').value.trim();
        const uf = document.getElementById('uf').value;
        const contato = document.getElementById('contato').value.trim();

        // Validações adicionais
        if (cnpj.length !== 14) {
            alert('CNPJ deve ter 14 dígitos');
            return;
        }

        if (uf.length !== 2) {
            alert('UF deve ter 2 caracteres');
            return;
        }

        const companyData = {
            razao_social: razaoSocial,
            cnpj: cnpj,
            endereco: endereco,
            cidade: cidade,
            uf: uf,
            contato: contato
        };

        try {
            let error;
            
            if (editingId) {
                // Atualizar empresa existente
                const { data, error: updateError } = await client
                    .from('dados_empresa')
                    .update(companyData)
                    .eq('id', editingId)
                    .select();
                
                error = updateError;
            } else {
                // VERIFICAR SE JÁ EXISTE UM REGISTRO ANTES DE INSERIR
                const { count, error: countError } = await client
                    .from('dados_empresa')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) throw countError;
                
                if (count > 0) {
                    alert('Já existe uma empresa cadastrada. Não é possível adicionar mais.');
                    return;
                }
                
                // Criar nova empresa
                const { data, error: insertError } = await client
                    .from('dados_empresa')
                    .insert([companyData])
                    .select();
                
                error = insertError;
            }

            if (error) {
                console.error('Detalhes do erro:', error);
                throw error;
            }

            // Fechar modal e recarregar lista
            const modal = bootstrap.Modal.getInstance(document.getElementById('companyModal'));
            if (modal) modal.hide();
            
            loadCompanies();
            
        } catch (error) {
            console.error('Erro completo ao salvar empresa:', error);
            
            // Mensagem de erro mais específica
            if (error.code === '23505') {
                alert('Erro: Já existe uma empresa com este CNPJ cadastrado.');
            } else if (error.message) {
                alert('Erro ao salvar empresa: ' + error.message);
            } else {
                alert('Erro ao salvar empresa. Verifique o console para mais detalhes.');
            }
        }
    }

        
        // Renderizar empresas na interface
        function renderCompanies() {
            const container = document.getElementById('companies-container');
            container.innerHTML = '';
            
            companies.forEach(company => {
                const card = document.createElement('div');
                card.className = 'col';
                card.innerHTML = `
                    <div class="card company-card h-100" onclick="editCompany(${company.id})">
                        <div class="card-body">
                            <h5 class="card-title">${company.razao_social}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${company.cnpj}</h6>
                            <p class="card-text">
                                <i class="bi bi-geo-alt"></i> ${company.endereco}, ${company.cidade} - ${company.uf}<br>
                                <i class="bi bi-person"></i> ${company.contato}
                            </p>
                        </div>
                        <div class="card-footer bg-transparent d-flex justify-content-end">
                            <button class="btn btn-sm btn-outline-primary btn-action me-2" onclick="event.stopPropagation(); editCompany(${company.id})">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="event.stopPropagation(); confirmDelete(${company.id})">
                                <i class="bi bi-trash"></i> Excluir
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Abrir modal para adicionar nova empresa
        function openModal() {
            editingId = null;
            document.getElementById('companyForm').reset();
            document.getElementById('companyModalLabel').textContent = 'Adicionar Nova Empresa';
            document.getElementById('deleteButton').style.display = 'none';
        }
        
        // Preencher modal para edição
        async function editCompany(id) {
            try {
                const { data, error } = await client
                    .from('dados_empresa')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                editingId = id;
                document.getElementById('companyId').value = id;
                document.getElementById('razao_social').value = data.razao_social;
                document.getElementById('cnpj').value = data.cnpj;
                document.getElementById('endereco').value = data.endereco;
                document.getElementById('cidade').value = data.cidade;
                document.getElementById('uf').value = data.uf;
                document.getElementById('contato').value = data.contato;
                
                document.getElementById('companyModalLabel').textContent = 'Editar Empresa';
                document.getElementById('deleteButton').style.display = 'inline-block';
                
                // Abrir o modal
                const modal = new bootstrap.Modal(document.getElementById('companyModal'));
                modal.show();
            } catch (error) {
                console.error('Erro ao carregar dados da empresa:', error);
                alert('Erro ao carregar dados da empresa. Verifique o console para mais detalhes.');
            }
        }
        
        // Salvar empresa (criar ou atualizar)
        async function saveCompany() {
            // Validação básica
            const form = document.getElementById('companyForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const companyData = {
                razao_social: document.getElementById('razao_social').value,
                cnpj: document.getElementById('cnpj').value.replace(/\D/g, ''),
                endereco: document.getElementById('endereco').value,
                cidade: document.getElementById('cidade').value,
                uf: document.getElementById('uf').value,
                contato: document.getElementById('contato').value
            };
            
            try {
                if (editingId) {
                    // Atualizar empresa existente
                    const { error } = await client
                        .from('dados_empresa')
                        .update(companyData)
                        .eq('id', editingId);
                    
                    if (error) throw error;
                } else {
                    // Criar nova empresa
                    const { error } = await client
                        .from('dados_empresa')
                        .insert([companyData]);
                    
                    if (error) throw error;
                }
                
                // Fechar modal e recarregar lista
                bootstrap.Modal.getInstance(document.getElementById('companyModal')).hide();
                loadCompanies();
                
            } catch (error) {
                console.error('Erro ao salvar empresa:', error);
                alert('Erro ao salvar empresa. Verifique o console para mais detalhes.');
            }
        }
        
        // Confirmar exclusão
        function confirmDelete(id) {
            if (confirm('Tem certeza que deseja excluir esta empresa?')) {
                deleteCompany(id);
            }
        }
        
        // Excluir empresa
        async function deleteCompany() {
            if (!editingId) return;
            
            try {
                const { error } = await client
                    .from('dados_empresa')
                    .delete()
                    .eq('id', editingId);
                
                if (error) throw error;
                
                // Fechar modal e recarregar lista
                bootstrap.Modal.getInstance(document.getElementById('companyModal')).hide();
                loadCompanies();
                
            } catch (error) {
                console.error('Erro ao excluir empresa:', error);
                alert('Erro ao excluir empresa. Verifique o console para mais detalhes.');
            }
        }
    </script>
</body>
</html>