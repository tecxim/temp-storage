<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Relatório de Pagamentos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        .card-header {
            background-color: #3498db;
            border-bottom: 1px solid #e3e6f0;
            padding: 0.75rem 1.25rem !important;
            margin-bottom: 0;
        }
        .card-header h5 {
            color: #fff;
            margin-bottom: 0;
        }
        .card-header button {
            margin-left: 10px;
        }
        .card-body {
            padding-top: 15px;
        }
        .total-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2e59d9;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 10px !important;
            margin-bottom: 15px !important;
            border-radius: 5px;
        }
        .table-responsive {
            overflow-x: auto;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="card shadow mb-4">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h5 class="m-0 font-weight-bold">RELATÓRIO DE PAGAMENTOS</h5>
                <div>
                    <span id="exportMessage" class="text-light me-2" style="display: none;">
                        <i class="bi bi-hourglass-split"></i> Gerando relatório...
                    </span>
                    <button id="exportExcel" class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-excel"></i> Exportar XLSX
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="filter-section">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="startDate" class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-4">
                            <label for="endDate" class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" id="filterButton" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Filtrar
                            </button>
                        </div>
                    </form>
                </div>
                <div class="table-responsive">
                    <table id="paymentsTable" class="table table-striped table-bordered" style="width:100%">
                        <thead class="table-light">
                            <tr>
                                <th>ID Venda</th>
                                <th>Valor Recebido</th>
                                <th>Total</th>
                                <th>Troco</th>
                                <th>Forma de Pagamento</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="total-display text-end">
                    Total: <span id="totalSum">R$ 0,00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- SheetJS (xlsx) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        const supabaseUrl = 'https://bhkigsipuxqgpafikglm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoa2lnc2lwdXhxZ3BhZmlrZ2xtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDE4NDMsImV4cCI6MjA3MTM3Nzg0M30.IBHX2UHeP7foTo96MFUAZUHc40O1gyNBeKqolhhceXM';
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        // Variáveis globais
        let paymentsData;
        let dataTable;

          // Função para formatar valor monetário
          function formatCurrency(value) {
              if (value === undefined || value === null || isNaN(value)) {
                  return 'R$ 0,00';
              }

              // Se for string, limpa e converte para float
              if (typeof value === 'string') {
                  value = parseFloat(
                      value
                          .replace('R$', '')
                          .trim()
                          .replace(/\./g, '')
                          .replace(',', '.')
                  );
              }

              // Se não for um número válido, retorna R$ 0,00
              if (isNaN(value)) {
                  return 'R$ 0,00';
              }

              // Formata o valor como moeda brasileira
              return 'R$ ' + value.toFixed(2).replace('.', ',');
          }

        // Função para converter data do formato internacional (YYYY-MM-DD HH:MM) para brasileiro (DD/MM/YYYY HH:MM)
        function formatBrazilianDate(dateStr) {
            if (!dateStr) return '';
            const [datePart, timePart] = dateStr.split(' ');
            const [year, month, day] = datePart.split('-');
            return `${day}/${month}/${year} ${timePart || ''}`;
        }

        // Função para converter string de data para objeto Date (para filtragem)
        function parseDateString(dateStr) {
            if (!dateStr) return null;
            const [datePart, timePart] = dateStr.split(' ');
            const [year, month, day] = datePart.split('-');
            return new Date(year, month - 1, day);
        }

        function updateTotalSum() {
            let total = 0;
            if (dataTable) {
                dataTable.rows({ search: 'applied' }).every(function() {
                    const rowData = this.data();
                    if (!rowData) return;
                    // Garante que o valor da coluna 'total' seja tratado como número
                    let value = rowData.total;
                    // Se for string, limpa e converte para float
                    if (typeof value === 'string') {
                        value = parseFloat(
                            value
                                .replace('R$', '')
                                .trim()
                                .replace(/\./g, '')
                                .replace(',', '.')
                        );
                    }
                    // Soma apenas se for um número válido
                    if (!isNaN(value)) {
                        total += value;
                    }
                });
            }
            // Exibe o total formatado
            $('#totalSum').text(formatCurrency(total));
        }



        // Função para inicializar a tabela
        function initializeDataTable() {
            if (!paymentsData || !Array.isArray(paymentsData)) {
                console.error("paymentsData não está definido ou não é um array.");
                return;
            }
            if ($.fn.DataTable.isDataTable('#paymentsTable')) {
                dataTable.clear().destroy();
            }
            dataTable = $('#paymentsTable').DataTable({
                data: paymentsData,
                columns: [
                    { data: 'id_venda', title: 'ID Venda' },
                    {
                        data: 'valor_recebido',
                        title: 'Valor Recebido',
                        render: formatCurrency
                    },
                    {
                        data: 'total',
                        title: 'Total',
                        render: formatCurrency
                    },
                    {
                        data: 'troco',
                        title: 'Troco',
                        render: formatCurrency
                    },
                    { data: 'forma_pagamento', title: 'Forma de Pagamento' },
                    {
                        data: 'data_pagto',
                        title: 'Data',
                        render: function(data) {
                            return formatBrazilianDate(data);
                        }
                    }
                ],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
                },
                responsive: true,
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                initComplete: function() {
                    updateTotalSum();
                },
                drawCallback: function() {
                    updateTotalSum();
                }
            });
        }

        // Função para aplicar os filtros
        function applyFilters() {
            const startDateInput = $('#startDate').val();
            const endDateInput = $('#endDate').val();
            const startDate = startDateInput ? new Date(startDateInput) : null;
            const endDate = endDateInput ? new Date(endDateInput) : null;
            if (endDate) {
                endDate.setDate(endDate.getDate() + 1);
            }
            $.fn.dataTable.ext.search = [];
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                const rowData = paymentsData[dataIndex];
                if (!rowData || !rowData.data_pagto) return true;
                const rowDate = parseDateString(rowData.data_pagto);
                if (startDate && rowDate < startDate) return false;
                if (endDate && rowDate >= endDate) return false;
                return true;
            });
            if (dataTable) {
                dataTable.draw();
            }
        }

        // Função para carregar dados do Supabase
        async function loadPaymentsData() {
            try {
                const { data, error } = await client
                    .from('pagamentos')
                    .select('*');
                if (error) throw error;
                paymentsData = data.map(row => ({
                    id_venda: row.id_venda,
                    valor_recebido: row.valor_recebido || '0',
                    total: row.total || '0',
                    troco: row.troco || '0',
                    forma_pagamento: row.forma_pagamento,
                    data_pagto: row.data_pagto
                }));
                console.log(paymentsData);
                initializeDataTable();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados. Por favor, recarregue a página.');
            }
        }

        $(document).ready(function() {
            if (!$('#paymentsTable').length) {
                console.error("Elemento #paymentsTable não encontrado.");
                return;
            }
            loadPaymentsData();

            $('#exportExcel').on('click', function() {
            if (!dataTable) {
                alert("A tabela não foi inicializada. Aguarde o carregamento dos dados.");
                return;
            }
            $('#exportMessage').show();
            const exportButton = $(this);
            exportButton.prop('disabled', true);

            setTimeout(function() {
                try {
                    const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();

                    // Função para limpar e converter valores monetários para exportação
                    const parseCurrencyForExport = (value) => {
                      if (typeof value === 'number') {
                          return value;
                      }

                      // Limpa e converte valores monetários para float
                      const cleanedValue = String(value)
                          .replace('R$', '')
                          .trim()
                          .replace(/\./g, '')
                          .replace(',', '.');

                      return parseFloat(cleanedValue) || 0;
                  };


                    const exportData = filteredData.map(row => ({
                        'ID Venda': row.id_venda,
                        'Valor Recebido': parseCurrencyForExport(row.valor_recebido),
                        'Total': parseCurrencyForExport(row.total),
                        'Troco': parseCurrencyForExport(row.troco),
                        'Forma de Pagamento': row.forma_pagamento,
                        'Data': formatBrazilianDate(row.data_pagto)
                    }));

                    // Captura o valor total exibido na label
                    const totalRecebidoLabel = $('#totalSum').text().trim();
                    const totalRecebidoValue = parseFloat(
                        totalRecebidoLabel
                            .replace('R$', '')
                            .trim()
                            .replace(/\./g, '')
                            .replace(',', '.')
                    ) || 0;

                    // Adiciona a linha de total
                    exportData.push({
                        'ID Venda': 'TOTAL RECEBIDO',
                        'Valor Recebido': totalRecebidoValue,
                        'Total': '',
                        'Troco': '',
                        'Forma de Pagamento': '',
                        'Data': ''
                    });

                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Relatório de Pagamentos");
                    XLSX.writeFile(wb, 'relatorio_pagamentos.xlsx');
                } catch (error) {
                    console.error('Erro ao exportar para Excel:', error);
                    alert('Ocorreu um erro ao gerar o relatório. Por favor, tente novamente.');
                } finally {
                    $('#exportMessage').hide();
                    exportButton.prop('disabled', false);
                }
            }, 100);
        });


            // Evento de filtro
            $('#filterButton').on('click', function() {
                applyFilters();
            });
        });
  </script>
</body>
</html>
